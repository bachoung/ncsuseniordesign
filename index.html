<!DOCTYPE html>
<html>
<head>
    <title>Profile Registration</title>
    <style>
        body {
            background-color: #ffd4d4;
        }
        
        fieldset {
            background-color: #e6e6e6;
            width: 300px;
            height: 500px;
            margin: auto;
        }

        legend {
            background-color: #c9c9c9;
            color: black;
            padding: 6px 12px;
        }

        input {
            margin: 2px;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center">Profile Registration</h1>
    <h2 style="text-align:center">North Carolina State University</h2>
    <!-- Code for the user input -->
    <!-- Action ID needs to match your Invoke URL of your API Gateway -->
    <form id="myForm" action="https://hvpi7zhzxd.execute-api.us-east-2.amazonaws.com/regwebsite" enctype="multipart/form-data">
        <fieldset style="text-align:center;">
            <legend>Create a Profile</legend><br>
            <label for="firstname">First Name:</label><br>
            <input type="text" id="firstname" name="firstname" required><br><br>
            <label for="lastname">Last Name:</label><br>
            <input type="text" id="lastname" name="lastname" required><br><br>
            <label for="phonenumber">Phone Number:</label><br>
            <input type="text" id="phonenumber" name="phonenumber" required><br><br>
            <label for="password">Password:</label><br>
            <input type="password" id="password" name="password" required><br><br>
            <label for="confirmpassword">Confirm Password:</label><br>
            <input type="password" id="confirmpassword" name="confirmpassword" required><br><br>
            <!-- File upload -->
            <input type="file" id="fileInput" style="display: none;">
            <button type="button" id="selectFileButton">Select file...</button><br><br>
            <button type="button" id="uploadButton" class="pure-button pure-button-primary">Upload</button>
        </fieldset>
    </form>

    <!-- Vue.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Axios CDN -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Vue.js script -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var password = document.getElementById("password");
            var confirmpassword = document.getElementById("confirmpassword");

            function validatePassword() {
                if (password.value != confirmpassword.value) {
                    confirmpassword.setCustomValidity("Passwords Don't Match");
                } else {
                    confirmpassword.setCustomValidity('');
                }
            }
            password.onchange = validatePassword;
            confirmpassword.onkeyup = validatePassword;
        });
        
      const MAX_IMAGE_SIZE = 1000000
      const API_ENDPOINT = 'https://hvpi7zhzxd.execute-api.us-east-2.amazonaws.com/regwebsite'

      new Vue({
        el: "#app",
        data: {
          image: '',
          uploadURL: ''
        },
        methods: {
          onFileChange (e) {
            let files = e.target.files || e.dataTransfer.files
            if (!files.length) return
            this.createImage(files[0])
          },
          createImage (file) {
            let reader = new FileReader()
            reader.onload = (e) => {
              console.log('length: ', e.target.result.includes('data:image/jpeg'))
              if (!e.target.result.includes('data:image/jpeg')) {
                return alert('Wrong file type - JPG only.')
              }
              if (e.target.result.length > MAX_IMAGE_SIZE) {
                return alert('Image is too large.')
              }
              this.image = e.target.result
            }
            reader.readAsDataURL(file)
          },
          removeImage: function (e) {
            console.log('Remove clicked')
            this.image = ''
          },
          uploadImage: async function (e) {
            console.log('Upload clicked')
            // Get the presigned URL
            const response = await axios({
              method: 'GET',
              url: API_ENDPOINT
            })
            console.log('Response: ', response)
            console.log('Uploading: ', this.image)
            let binary = atob(this.image.split(',')[1])
            let array = []
            for (var i = 0; i < binary.length; i++) {
              array.push(binary.charCodeAt(i))
            }
            let blobData = new Blob([new Uint8Array(array)], {type: 'image/jpeg'})
            console.log('Uploading to: ', response.uploadURL)
            const result = await fetch(response.uploadURL, {
              method: 'PUT',
              body: blobData
            })
            console.log('Result: ', result)
            // Final URL for the user doesn't need the query string params
            this.uploadURL = response.uploadURL.split('?')[0]
          }
        }
      })
    </script>
</body>
</html>
