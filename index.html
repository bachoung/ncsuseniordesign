import json
import boto3
import mimetypes
import unicodedata
from botocore.exceptions import ClientError

s3 = boto3.client('s3')

def create_presigned_post(bucket_name, key, content_type):
    try:
        response = s3.generate_presigned_post(
            Bucket=bucket_name,
            Key=key,
            Fields={"Content-Type": content_type},
            Conditions=[
                {"Content-Type": content_type},
                {"acl": "public-read"}
            ],
            ExpiresIn=3600
        )
        return response
    except ClientError as e:
        print("Error generating pre-signed URL: ", e)
        return None

def lambda_handler(event, context):
    print("Received event:", json.dumps(event))
    
    # Extract form data from query string parameters
    form_data = event.get('queryStringParameters', {})
    
    # Construct text to store
    text = format_text(form_data)
    
    # Name of the S3 bucket where you want to store the text
    bucket_name = 'security-fileupload'
    
    # Extract phone number from form data
    phonenumber = form_data.get('phonenumber', '')
    
    # Construct key using phone number as part of the folder path and filename
    key = f"{phonenumber}/ProfileInformation.txt"
    
    try:
        # Store the text in the S3 bucket
        s3.put_object(Bucket=bucket_name, Key=key, Body=text)
        
        # Generate pre-signed post data for file upload
        file_name = form_data.get('file', '')
        content_type = mimetypes.guess_type(file_name)[0] or 'application/octet-stream'
        presigned_post_data = create_presigned_post(bucket_name, f"{phonenumber}/{file_name}", content_type)
        
        if presigned_post_data:
            return {
                'statusCode': 200,
                'body': json.dumps({
                    'message': 'Registration data stored successfully',
                    'presigned_post_data': presigned_post_data
                })
            }
        else:
            return {
                'statusCode': 500,
                'body': json.dumps('Error generating pre-signed post data')
            }
    except Exception as e:
        print("Error storing data in S3:", e)
        return {
            'statusCode': 500,
            'body': json.dumps('Error storing registration data')
        }

def format_text(form_data):
    firstname = form_data.get('firstname', '')
    lastname = form_data.get('lastname', '')
    phonenumber = form_data.get('phonenumber', '')
    password = form_data.get('password', '')
    confirmpassword = form_data.get('confirmpassword', '')
    file = form_data.get('file', '')
    
    # Creating the txt file containing the personal info
    text = f"First Name: {firstname}\nLast Name: {lastname}\nPhonenumber: {phonenumber}\nPassword: {password}\nFile: {file}"
    return text
